<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Report Stok Opname Toko 2025 - HijabHasna</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Playfair Display', serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #333;
      padding: 8px;
      text-align: center;
    }
    ul {
      padding-left: 15px;
      text-align: left;
    }
    button {
      margin: 1px;
      padding: 6px 12px;
    }
  </style>
</head>
<body>

<!-- Tombol kembali ke menu -->
<button onclick="goToHome()" style="background-color: #2196F3; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 20px;">
  â¬… Kembali ke Menu Awal
</button>

<!-- Info user login -->
<div id="user-info" style="text-align:right; margin-bottom:10px; font-weight:bold; display: none;">
  ðŸ‘¤ Login sebagai: <span id="userName">...</span>
</div>

<h2>Report Stok Opname Toko 2025</h2>

<table id="soTable">
  <thead>
    <tr>
      <th rowspan="2">NO</th>
      <th rowspan="2">NAMA TOKO</th>
      <th rowspan="2">TANGGAL POSTING</th>
      <th colspan="2">STOK</th>
      <th rowspan="2">SELISIH</th>
      <th rowspan="2">UPLOAD FILE PENDUKUNG</th>
      <th rowspan="2">AKSI</th>
    </tr>
    <tr>
      <th>SEBELUM SO</th>
      <th>SESUDAH SO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td><input type="text"></td>
      <td><input type="date"></td>
      <td><input type="number" onchange="hitungSelisih(this)"></td>
      <td><input type="number" onchange="hitungSelisih(this)"></td>
      <td class="selisih">0</td>
      <td>
        <input type="file" multiple onchange="previewFiles(this)">
        <ul class="file-list"></ul>
      </td>
      <td>
        <button onclick="tambahBaris()">Tambah Baris</button>
      </td>
    </tr>
  </tbody>
</table>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBRrKuPP5iTD23ougJchfyEx6WxSGdm99M",
    authDomain: "hijab-hasna.firebaseapp.com",
    projectId: "hijab-hasna",
  };

  firebase.initializeApp(firebaseConfig);

  const adminEmails = ["zahsui57@gmail.com", "hayatimamsubekti@gmail.com", "ummizakiyyah1@gmail.com"];

 firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    document.getElementById("user-info").style.display = "block";
    document.getElementById("userName").textContent = user.email;

    const isAdmin = adminEmails.includes(user.email);
    toggleFormAccess(isAdmin);

    // â¬‡ Tambahkan ini untuk memuat data dari localStorage
    muatDariLocalStorage();
  } else {
    alert("Silakan login terlebih dahulu.");
    window.location.href = "/login.html";
  }
});


  function muatDariLocalStorage() {
  const data = JSON.parse(localStorage.getItem("reportSO2025"));
  if (data && data.length > 0) {
    const table = document.getElementById("soTable").getElementsByTagName("tbody")[0];
    table.innerHTML = "";
    data.forEach((item, i) => {
      const row = table.insertRow(-1);
      row.innerHTML = `
        <td>${i + 1}</td>
        <td><input type="text" value="${item.namaToko}" onchange="simpanKeLocalStorage()"></td>
        <td><input type="date" value="${item.tanggal}" onchange="simpanKeLocalStorage()"></td>
        <td><input type="number" value="${item.sebelum}" onchange="hitungSelisih(this); simpanKeLocalStorage()"></td>
        <td><input type="number" value="${item.sesudah}" onchange="hitungSelisih(this); simpanKeLocalStorage()"></td>
        <td class="selisih">${item.sebelum - item.sesudah}</td>
        <td>
          <input type="file" multiple onchange="previewFiles(this)">
          <ul class="file-list"></ul>
        </td>
        <td><button onclick="tambahBaris()">Tambah Baris</button></td>
      `;
    });
  }
}


  function login() {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider);
  }

  function logout() {
    firebase.auth().signOut().then(() => {
      location.reload();
    });
  }

  function goToHome() {
    window.location.href = "/index.html";
  }

  function toggleFormAccess(isAdmin) {
    const inputs = document.querySelectorAll("input, button");
    inputs.forEach(input => {
      if (input.type !== "button" || input.textContent === "Tambah Baris") {
        input.disabled = !isAdmin;
      }
    });
  }

  function hitungSelisih(input) {
    const row = input.closest("tr");
    const sebelumSO = parseInt(row.cells[3].querySelector("input").value) || 0;
    const sesudahSO = parseInt(row.cells[4].querySelector("input").value) || 0;
    const selisih = sebelumSO - sesudahSO;
    row.querySelector(".selisih").textContent = selisih;
  }

  function previewFiles(input) {
    const fileListContainer = input.nextElementSibling;
    fileListContainer.innerHTML = "";

    for (const file of input.files) {
      const listItem = document.createElement("li");
      listItem.textContent = file.name;
      fileListContainer.appendChild(listItem);
    }
  }

function tambahBaris() {
  const table = document.getElementById("soTable").getElementsByTagName("tbody")[0];
  const rowCount = table.rows.length;
  const row = table.insertRow(-1);

  row.innerHTML = `
    <td>${rowCount + 1}</td>
    <td><input type="text" onchange="simpanKeLocalStorage()"></td>
    <td><input type="date" onchange="simpanKeLocalStorage()"></td>
    <td><input type="number" onchange="hitungSelisih(this)"></td>
    <td><input type="number" onchange="hitungSelisih(this)"></td>
    <td class="selisih">0</td>
    <td>
      <input type="file" multiple onchange="previewFiles(this)">
      <ul class="file-list"></ul>
    </td>
    <td>
      <button onclick="tambahBaris()">Tambah Baris</button>
    </td>
  `;

  simpanKeLocalStorage(); // â† Tambahkan ini agar baris langsung disimpan
}

function hitungSelisih(input) {
  const row = input.closest("tr");
  const sebelumSO = parseInt(row.cells[3].querySelector("input").value) || 0;
  const sesudahSO = parseInt(row.cells[4].querySelector("input").value) || 0;
  const selisih = sebelumSO - sesudahSO;
  row.querySelector(".selisih").textContent = selisih;
  simpanKeLocalStorage();
}

  function simpanKeLocalStorage() {
  const rows = [];
  document.querySelectorAll("#soTable tbody tr").forEach(tr => {
    rows.push({
      namaToko: tr.cells[1].querySelector("input").value,
      tanggal: tr.cells[2].querySelector("input").value,
      sebelum: tr.cells[3].querySelector("input").value,
      sesudah: tr.cells[4].querySelector("input").value,
    });
  });
  localStorage.setItem("reportSO2025", JSON.stringify(rows));
}

</script>

</body>
</html>
